<!DOCTYPE html>
<html lang="ru">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>LoFi Radio</title>
   <script src="https://telegram.org/js/telegram-web-app.js"></script>
   <style>
       body, html { 
           margin: 0; 
           padding: 0; 
           width: 100%; 
           height: 100%; 
           overflow: hidden; 
           font-family: Arial, sans-serif; 
           color: #fff;
           transition: all 0.3s ease;
       }
       
       /* –í–∏–¥–µ–æ—Ñ–æ–Ω */
       #bg-video { 
           position: fixed; 
           top: 0; 
           left: 0; 
           width: 100%; 
           height: 100%; 
           object-fit: cover; 
           z-index: -1;
           transition: opacity 0.5s ease;
       }
       
       /* Telegram —Ç–µ–º–∞ (—Ñ–æ–Ω –±–µ–∑ –≤–∏–¥–µ–æ) */
       .theme-telegram {
           background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
       }
       
       .controls { 
           position: relative; 
           z-index: 1; 
           background: rgba(0,0,0,0.4);
           padding: 20px; 
           border-radius: 12px; 
           max-width: 400px; 
           margin: 50px auto; 
           text-align: center;
           border: 1px solid rgba(255,255,255,0.3);
           box-shadow: 0 4px 20px rgba(0,0,0,0.2);
       }
       
       h1 { 
           margin-bottom: 20px; 
           font-size: 24px;
           color: #fff;
           text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
       }
       
       select, button, input[type=range] { 
           width: 100%; 
           margin: 10px 0; 
           padding: 10px; 
           border-radius: 8px; 
           border: none; 
           font-size: 16px; 
       }
       
       select { 
           background-color: rgba(51,51,51,0.9);
           color: #fff;
           border: 1px solid rgba(255,255,255,0.3);
       }
       
       button { 
           cursor: pointer; 
           background-color: #ff6f61; 
           color: white; 
           font-weight: bold; 
           transition: transform 0.2s, background-color 0.2s; 
           border: none;
       }
       
       button:hover { 
           transform: scale(1.05); 
           background-color: #ff4b3e;
       }
       
       button:disabled { 
           background-color: #666; 
           cursor: not-allowed; 
           transform: none; 
       }
       
       input[type=range] { 
           -webkit-appearance: none; 
           background: #444; 
           height: 8px; 
       }
       
       input[type=range]::-webkit-slider-thumb { 
           -webkit-appearance: none; 
           width: 20px; 
           height: 20px; 
           background: #ff6f61; 
           border-radius: 50%; 
           cursor: pointer; 
       }
       
       input[type=range]::-moz-range-thumb {
           width: 20px; 
           height: 20px; 
           background: #ff6f61; 
           border-radius: 50%; 
           cursor: pointer;
           border: none;
       }
       
       .loading { 
           display: none; 
           font-size: 14px; 
           color: #ff6f61; 
       }
       
       .volume-container { 
           margin: 10px 0; 
       }
       
       .mobile-note { 
           font-size: 12px; 
           color: #ccc; 
           margin-top: 5px; 
           display: none;
           text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
       }
       
       /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º */
       .themes-container {
           margin: 15px 0;
           padding: 10px;
           background: rgba(255,255,255,0.15);
           border-radius: 8px;
           border: 1px solid rgba(255,255,255,0.2);
       }
       
       .themes-title {
           font-size: 14px;
           margin-bottom: 10px;
           color: #fff;
           font-weight: bold;
           text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
       }
       
       .themes-grid {
           display: grid;
           grid-template-columns: repeat(3, 1fr);
           gap: 8px;
       }
       
       .theme-btn {
           padding: 8px 12px;
           font-size: 12px;
           border-radius: 6px;
           background: rgba(255,255,255,0.25);
           color: #fff;
           border: 2px solid transparent;
           cursor: pointer;
           transition: all 0.2s ease;
           margin: 2px;
           text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
       }
       
       .theme-btn:hover {
           transform: scale(1.02);
           background: rgba(255,255,255,0.35);
       }
       
       .theme-btn.active {
           border-color: #ff6f61;
           background: #ff6f61;
           color: white;
           text-shadow: none;
       }
       
       /* –õ–µ–π–±–ª –¥–ª—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏ */
       label {
           color: #fff;
           font-size: 14px;
           text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
       }

       /* –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ */
       #subscription-status {
           position: fixed;
           top: 10px;
           right: 10px;
           background: rgba(255, 255, 255, 0.9);
           padding: 5px 12px;
           border-radius: 15px;
           font-size: 12px;
           color: #333;
           z-index: 1000;
           display: none;
       }

       /* –≠–∫—Ä–∞–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–æ—Å—Ç—É–ø–∞ */
       #access-blocked {
           position: fixed;
           top: 0;
           left: 0;
           width: 100vw;
           height: 100vh;
           background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
           display: none;
           justify-content: center;
           align-items: center;
           z-index: 10000;
           font-family: Arial, sans-serif;
       }

       .block-content {
           background: rgba(255, 255, 255, 0.95);
           border-radius: 20px;
           padding: 30px;
           text-align: center;
           max-width: 400px;
           margin: 20px;
           box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
       }

       .block-icon {
           font-size: 64px;
           margin-bottom: 20px;
       }

       .block-content h2 {
           color: #333;
           margin: 0 0 10px 0;
           font-size: 24px;
           font-weight: 600;
       }

       .block-status {
           color: #666;
           font-size: 16px;
           margin: 0 0 20px 0;
       }

       .block-description {
           color: #555;
           line-height: 1.5;
           margin-bottom: 25px;
       }

       .subscription-benefits {
           background: rgba(102, 126, 234, 0.1);
           border-radius: 15px;
           padding: 20px;
           margin: 20px 0;
       }

       .subscription-benefits h3 {
           margin: 0 0 15px 0;
           color: #4c63d2;
           font-size: 18px;
       }

       .subscription-benefits ul {
           list-style: none;
           padding: 0;
           margin: 0;
       }

       .subscription-benefits li {
           padding: 5px 0;
           color: #555;
       }

       .subscription-options {
           display: flex;
           gap: 15px;
           justify-content: center;
           margin: 25px 0;
       }

       .option {
           background: white;
           border: 2px solid #e1e5e9;
           border-radius: 12px;
           padding: 15px;
           min-width: 80px;
           position: relative;
           transition: all 0.3s ease;
       }

       .option.recommended {
           border-color: #4c63d2;
           transform: scale(1.05);
       }

       .save-badge {
           position: absolute;
           top: -8px;
           left: 50%;
           transform: translateX(-50%);
           background: #4c63d2;
           color: white;
           font-size: 10px;
           padding: 2px 8px;
           border-radius: 10px;
           font-weight: 600;
       }

       .price {
           display: block;
           font-size: 20px;
           font-weight: bold;
           color: #333;
       }

       .period {
           font-size: 12px;
           color: #666;
       }

       .save-text {
           display: block;
           font-size: 10px;
           color: #4c63d2;
           margin-top: 5px;
       }

       .return-btn {
           background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
           color: white;
           border: none;
           border-radius: 25px;
           padding: 15px 30px;
           font-size: 16px;
           font-weight: 600;
           cursor: pointer;
           margin: 20px 0 10px 0;
           transition: transform 0.2s ease;
           min-width: 200px;
       }

       .return-btn:hover {
           transform: translateY(-2px);
       }

       .referral-hint {
           font-size: 14px;
           color: #666;
           margin: 15px 0 0 0;
       }
       
       @media (max-width: 768px) {
           .mobile-note { 
               display: block; 
           }
           
           .controls {
               margin: 20px auto;
               max-width: 350px;
               padding: 15px;
           }
           
           h1 {
               font-size: 20px;
           }
           
           .themes-grid {
               grid-template-columns: repeat(3, 1fr);
           }
           
           .theme-btn {
               font-size: 11px;
               padding: 6px 8px;
           }
           
           select, button {
               font-size: 14px;
               padding: 8px;
           }

           .block-content {
               margin: 10px;
               padding: 20px;
           }
           
           .subscription-options {
               flex-direction: column;
               align-items: center;
           }
           
           .option {
               width: 120px;
           }
       }
       
       /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ */
       * {
           -webkit-tap-highlight-color: transparent;
       }
       
       select:focus, button:focus {
           outline: 2px solid #ff6f61;
           outline-offset: 2px;
       }
   </style>
</head>
<body>
   <!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ -->
   <div id="subscription-status"></div>

   <!-- –≠–∫—Ä–∞–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–æ—Å—Ç—É–ø–∞ -->
   <div id="access-blocked">
       <div class="block-content">
           <div class="block-icon">‚è∞</div>
           <h2>–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h2>
           <p class="block-status" id="block-status-text">–î–æ—Å—Ç—É–ø –∏—Å—Ç–µ–∫</p>
           <p class="block-description">
               –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è LoFi —Ä–∞–¥–∏–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
           </p>
           
           <div class="subscription-benefits">
               <h3>üéµ –ß—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ –ø–æ–¥–ø–∏—Å–∫—É:</h3>
               <ul>
                   <li>üéµ 6 —Ä–∞–¥–∏–æ—Å—Ç–∞–Ω—Ü–∏–π –±–µ–∑ —Ä–µ–∫–ª–∞–º—ã</li>
                   <li>üé® 5 —Ç–µ–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</li>
                   <li>üîä –í—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∑–≤—É–∫–∞</li>
                   <li>‚ö° –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞</li>
               </ul>
           </div>
           
           <div class="subscription-options">
               <div class="option">
                   <span class="price">70‚ÇΩ</span>
                   <span class="period">/ –º–µ—Å—è—Ü</span>
               </div>
               <div class="option recommended">
                   <span class="save-badge">–í—ã–≥–æ–¥–Ω–æ!</span>
                   <span class="price">180‚ÇΩ</span>
                   <span class="period">/ 3 –º–µ—Å—è—Ü–∞</span>
                   <span class="save-text">—ç–∫–æ–Ω–æ–º–∏—è 14%</span>
               </div>
           </div>
           
           <button onclick="returnToBot()" class="return-btn">
               üí≥ –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
           </button>
           
           <p class="referral-hint">
               üí° –ò–ª–∏ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∏—Ç–µ –±–æ–Ω—É—Å–Ω—ã–µ –¥–Ω–∏!
           </p>
       </div>
   </div>

   <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —Ä–∞–¥–∏–æ -->
   <div id="main-content">
       <video autoplay muted loop playsinline id="bg-video">
           <source src="https://nikitataflowny-create.github.io/tg-lofi-radio/bg.mp4" type="video/mp4">
           –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
       </video>

       <div class="controls">
           <h1 id="station-name">LoFi Radio</h1>
           
           <select id="station-select">
               <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏—é</option>
           </select>
           
           <button id="play-pause" disabled>‚ñ∂Ô∏è Play</button>
           
           <div class="loading" id="loading">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
           
           <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º -->
           <div class="themes-container">
               <div class="themes-title">üé® –¢–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</div>
               <div class="themes-grid" id="themes-grid">
                   <!-- –¢–µ–º—ã –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
               </div>
           </div>
           
           <div class="volume-container">
               <label for="volume">–ì—Ä–æ–º–∫–æ—Å—Ç—å:</label>
               <input type="range" id="volume" min="0" max="1" step="0.01" value="0.5">
               <div class="mobile-note">–ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –≥—Ä–æ–º–∫–æ—Å—Ç–∏</div>
           </div>
       </div>

       <audio id="audio" preload="none"></audio>
   </div>

   <script>
       // –ú–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏
       class SubscriptionManager {
           constructor() {
               this.apiUrl = 'http://localhost:8080/api/check-subscription';
               this.userId = null;
               this.hasAccess = false;
           }

           async init() {
               console.log('üîç Initializing subscription check...');
               
               // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
               if (window.Telegram && window.Telegram.WebApp) {
                   const tg = window.Telegram.WebApp;
                   tg.ready();
                   
                   // –ü–æ–ª—É—á–∞–µ–º user_id –∏–∑ initDataUnsafe
                   if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                       this.userId = tg.initDataUnsafe.user.id;
                       console.log(`üë§ User ID: ${this.userId}`);
                   } else {
                       console.warn('‚ö†Ô∏è No user data from Telegram WebApp');
                       // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                       this.userId = 12345;
                   }
               } else {
                   console.warn('‚ö†Ô∏è Not running in Telegram WebApp');
                   // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                   this.userId = 12345;
               }

               // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
               await this.checkSubscription();
           }

           async checkSubscription() {
               if (!this.userId) {
                   console.error('‚ùå No user ID available');
                   this.blockAccess('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                   return;
               }

               try {
                   console.log(`üîç Checking subscription for user ${this.userId}...`);
                   
                   const response = await fetch(`${this.apiUrl}/${this.userId}`);
                   const data = await response.json();
                   
                   console.log('üìä Subscription status:', data);
                   
                   if (data.has_access) {
                       this.hasAccess = true;
                       this.allowAccess(data);
                   } else {
                       this.hasAccess = false;
                       this.blockAccess('–î–æ—Å—Ç—É–ø –∏—Å—Ç–µ–∫', data);
                   }
                   
               } catch (error) {
                   console.error('‚ùå Error checking subscription:', error);
                   // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ API - —Ä–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø (fallback)
                   console.log('üîÑ API error, allowing access as fallback');
                   this.hasAccess = true;
                   this.allowAccess({ status: 'api_error' });
               }
           }

           allowAccess(data) {
               console.log('‚úÖ Access granted');
               
               // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
               document.getElementById('main-content').style.display = 'block';
               document.getElementById('access-blocked').style.display = 'none';
               
               // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
               this.updateStatusDisplay(data);
           }

           blockAccess(reason, data = {}) {
               console.log('üö´ Access blocked:', reason);
               
               // –°–∫—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
               document.getElementById('main-content').style.display = 'none';
               
               // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
               this.showBlockScreen(reason, data);
           }

           showBlockScreen(reason, data) {
               const blockScreen = document.getElementById('access-blocked');
               const statusText = document.getElementById('block-status-text');
               
               const statusMessage = data.status === 'trial_expired' ? '–¢—Ä–∏–∞–ª –∏—Å—Ç–µ–∫' : 
                                   data.status === 'subscription_expired' ? '–ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞' : 
                                   '–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω';

               statusText.textContent = statusMessage;
               blockScreen.style.display = 'flex';
           }

           updateStatusDisplay(data) {
               const statusElement = document.getElementById('subscription-status');
               if (data.status && data.status !== 'api_error') {
                   const statusText = data.status === 'trial_active' ? 
                       `üéÅ –¢—Ä–∏–∞–ª: ${data.days_left || 0} –¥–Ω–µ–π` :
                       data.status === 'subscription_active' ? 
                       `‚≠ê –ü–æ–¥–ø–∏—Å–∫–∞: ${data.days_left || 0} –¥–Ω–µ–π` :
                       '';
                   
                   if (statusText) {
                       statusElement.textContent = statusText;
                       statusElement.style.display = 'block';
                   }
               }
           }
       }

       // –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –±–æ—Ç (–≥–ª–æ–±–∞–ª—å–Ω–∞—è)
       function returnToBot() {
           if (window.Telegram && window.Telegram.WebApp) {
               window.Telegram.WebApp.close();
           } else {
               alert('–í–æ–∑–≤—Ä–∞—Ç –≤ –±–æ—Ç–∞...');
           }
       }

       // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ–º
       const themes = [
           {
               id: 'city',
               name: '1',
               video: 'bg.mp4',
               description: '–¢–µ–º–∞ 1'
           },
           {
               id: 'studio',
               name: '2',
               video: 'video2.mp4',
               description: '–¢–µ–º–∞ 2'
           },
           {
               id: 'room',
               name: '3',
               video: 'video3.mp4',
               description: '–¢–µ–º–∞ 3'
           },
           {
               id: 'fourth',
               name: '4',
               video: 'video4.mp4',
               description: '–¢–µ–º–∞ 4'
           },
           {
               id: 'telegram',
               name: 'Telegram',
               video: null,
               description: '–¶–≤–µ—Ç–∞ –∏–∑ –≤–∞—à–µ–≥–æ Telegram'
           }
       ];

       // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å—Ç–∞–Ω—Ü–∏–π
       const stations = [
           {
               id: 1,
               name: "Beats",
               url: "https://stream.laut.fm/lofi"
           },
           {
               id: 2,
               name: "24/7",
               url: "https://ec3.yesstreaming.net:3755/stream"
           },
           {
               id: 3,
               name: "Chill",
               url: "https://chill.radioca.st/stream"
           },
           {
               id: 4,
               name: "ChillOut",
               url: "https://stream.laut.fm/chillout"
           },
           {
               id: 5,
               name: "Live",
               url: "https://live.lofiradio.ru/lofi_mp3_128"
           },
           {
               id: 6,
               name: "LoF",
               url: "https://play.lofiradio.ru:8000/mp3_320"
           }
       ];

       // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
       const video = document.getElementById('bg-video');
       const audio = document.getElementById('audio');
       const playPauseBtn = document.getElementById('play-pause');
       const volumeSlider = document.getElementById('volume');
       const stationSelect = document.getElementById('station-select');
       const stationName = document.getElementById('station-name');
       const loading = document.getElementById('loading');
       const themesGrid = document.getElementById('themes-grid');

       let currentStation = null;
       let currentTheme = 'city'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
       let isPlaying = false;
       let subscriptionManager;

       // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
       async function init() {
           // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
           if (window.Telegram?.WebApp) {
               window.Telegram.WebApp.ready();
               window.Telegram.WebApp.expand();
               // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º—É
               document.body.style.backgroundColor = window.Telegram.WebApp.backgroundColor || '#000';
           }

           // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–¥–ø–∏—Å–æ–∫ –ü–ï–†–í–´–ú
           subscriptionManager = new SubscriptionManager();
           await subscriptionManager.init();

           // –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–∞–¥–∏–æ
           if (subscriptionManager.hasAccess) {
               loadStations();
               loadThemes();
               setupEventListeners();
               loadSavedTheme();
           }
       }

       // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞–Ω—Ü–∏–π
       function loadStations() {
           stationSelect.innerHTML = '<option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏—é</option>';
           
           stations.forEach(station => {
               const option = document.createElement('option');
               option.value = station.id;
               option.textContent = station.name;
               option.dataset.station = JSON.stringify(station);
               stationSelect.appendChild(option);
           });
       }

       // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º
       function loadThemes() {
           themesGrid.innerHTML = '';
           
           themes.forEach(theme => {
               const button = document.createElement('button');
               button.className = 'theme-btn';
               button.textContent = theme.name;
               button.title = theme.description;
               button.onclick = () => changeTheme(theme.id);
               
               if (theme.id === currentTheme) {
                   button.classList.add('active');
               }
               
               themesGrid.appendChild(button);
           });
       }

       // –°–º–µ–Ω–∞ —Ç–µ–º—ã
       function changeTheme(themeId) {
           const theme = themes.find(t => t.id === themeId);
           if (!theme) return;

           currentTheme = themeId;
           
           // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
           document.querySelectorAll('.theme-btn').forEach(btn => {
               btn.classList.remove('active');
           });
           event.target.classList.add('active');

           if (theme.video) {
               // –í–∏–¥–µ–æ —Ç–µ–º–∞
               document.body.classList.remove('theme-telegram');
               video.style.display = 'block';
               
               // –ü–ª–∞–≤–Ω–∞—è —Å–º–µ–Ω–∞ –≤–∏–¥–µ–æ
               video.style.opacity = '0';
               setTimeout(() => {
                   video.src = `https://nikitataflowny-create.github.io/tg-lofi-radio/${theme.video}`;
                   video.style.opacity = '1';
                   video.play().catch(e => console.log('Video autoplay failed:', e));
               }, 200);
           } else {
               // Telegram —Ü–≤–µ—Ç–∞
               video.style.opacity = '0';
               setTimeout(() => {
                   video.style.display = 'none';
                   document.body.classList.add('theme-telegram');
               }, 200);
           }

           // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä
           try {
               localStorage.setItem('lofi-theme', themeId);
           } catch (e) {
               console.log('LocalStorage not available');
           }
       }

       // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Ç–µ–º—ã
       function loadSavedTheme() {
           try {
               const savedTheme = localStorage.getItem('lofi-theme');
               if (savedTheme && themes.find(t => t.id === savedTheme)) {
                   // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É —Ç–µ–º—ã –∏ –∫–ª–∏–∫–∞–µ–º –Ω–∞ –Ω–µ—ë
                   setTimeout(() => {
                       const themeButton = Array.from(document.querySelectorAll('.theme-btn'))
                           .find(btn => btn.textContent === themes.find(t => t.id === savedTheme).name);
                       if (themeButton) {
                           themeButton.click();
                       }
                   }, 500);
               }
           } catch (e) {
               console.log('LocalStorage not available');
           }
       }

       // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
       function setupEventListeners() {
           playPauseBtn.addEventListener('click', togglePlayPause);
           volumeSlider.addEventListener('input', updateVolume);
           stationSelect.addEventListener('change', changeStation);
           
           audio.addEventListener('loadstart', () => showLoading(true));
           audio.addEventListener('loadeddata', () => showLoading(false));
           audio.addEventListener('error', handleAudioError);
           audio.addEventListener('play', () => updatePlayButton(true));
           audio.addEventListener('pause', () => updatePlayButton(false));
       }

       // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
       function togglePlayPause() {
           if (!currentStation) return;

           if (audio.paused) {
               audio.play().catch(handleAudioError);
           } else {
               audio.pause();
           }
       }

       // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
       function updateVolume() {
           try {
               audio.volume = volumeSlider.value;
           } catch (e) {
               console.log('Volume control not supported on this device');
           }
       }

       // –°–º–µ–Ω–∞ —Å—Ç–∞–Ω—Ü–∏–∏
       function changeStation() {
           const selectedOption = stationSelect.selectedOptions[0];
           if (!selectedOption) return;

           currentStation = JSON.parse(selectedOption.dataset.station);
           
           // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
           stationName.textContent = currentStation.name;
           
           // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
           audio.pause();
           
           // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—É—é —Å—Ç–∞–Ω—Ü–∏—é
           audio.src = currentStation.url;
           audio.load();
           
           // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
           playPauseBtn.disabled = false;
           
           // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–∏–Ω–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
           audio.play().catch(handleAudioError);
       }

       // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
       function showLoading(show) {
           loading.style.display = show ? 'block' : 'none';
       }

       // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
       function updatePlayButton(playing) {
           isPlaying = playing;
           playPauseBtn.textContent = playing ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Play';
       }

       // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∞—É–¥–∏–æ
       function handleAudioError(error) {
           console.error('Audio error:', error);
           showLoading(false);
           updatePlayButton(false);
       }

       // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
       init();
   </script>
</body>
</html>
